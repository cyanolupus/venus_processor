# 金星プロセッサ仕様書
ver 0.9 2010/08/24 冨安洋史

from: <https://www.ddna.cs.tsukuba.ac.jp/lecture/lsi_design/index.html>

## 概要
金星プロセッサは教育用として設計されており、単純な Fetch, Decode, Execute, Write Back の 4段のパイプラインを持ち，比較的容易に設計できるように配慮されている．

## レジスタ構成
金星プロセッサは，以下のソフトウエアから見えるレジスタ(Architectural Register)を持つ．
- 汎用レジスタ 32 bit 16 本

- フラグレジスタ 6 bit 1 本

## メモリ構成
リトルエンディアン形式．32 bit/word 毎のアクセスのみをサポートする．32 bit の単一なフラットなメモリ空間を持つ．アドレッシングモードは，インデックスレジスタ+ディスプレースメント形式のみ．

## 命令セット
RISC の系統に属する．各命令の仕様およびコード割り当てについては金星プロセッサ命令表を参照。以下に特徴を述べる．
(a) ロードストアアーキテクチャ
(b) 32 bit 固定長命令
(c) 2オペランド形式
(e) 分岐命令はフラグとcondition codeを用いる

## パイプライン分割
図1. に金星プロセッサのパイプライン構成を示す．金星プロセッサではあまり動作周波数を考慮せず，直感的で判りやすいパイプライン分割を採った．分岐予測やフォワーディング等を持たない，古典的なパイプラインである．金星プロセッサのパイプラインはFetch, Decode, Execute, Write Backから成る．Execution ステージは命令によって 1 ～ 2 段で構成される．整数演算，論理演算，シフト演算は1段で実行される．Load/Store は 2 段で実行される．

### Fetch
プログラムカウンタに従って，メモリから命令を読みこむ．
分岐成立時は分岐先の命令を読み込む．
### Decode
命令をデコードし，Execute ステージで制御しやすい形にする．
定数を切り出し，Execute ステージで使える形にする．
レジスタを読み込む．
使用するレジスタに書き込み予約が為されているときは，書き込みが終了するまで待つ．
### Execute
命令に従って実行する．
フラグレジスタの値によって，実行するかしないかを制御する．
### Write Back
結果をレジスタに格納する．

### 汎用レジスタセット，浮動小数点レジスタセット
金星プロセッサは 16 本の 32 bit 汎用レジスタを持つ．汎用レジスタは全て等価である．書き込み予約を記録するため，各レジスタは1 bit の書き込み予約フラグを持つ．
Decode ステージで 2 つのレジスタを読み出し，Write Back ステージで 1 つのレジスタへ書き込むため，各レジスタセットは少なくとも 2 つの read ポート，1 つの write ポートが必要である．

### ステータスレジスタ
金星プロセッサは内部状態を示すレジスタを持つ．以下にこれらのレジスタを示す．
(i) フラグレジスタ
前命令の演算結果を示す．6 bit からなる．

## 実行ステージ

### Fetch ステージ
命令メモリから命令を読み出す．簡単のために，命令メモリは32 bit word のD-FF アレイを仮定する．プログラムカウンタに従って一語ずつ命令を読み出す．分岐命令実行時はパイプラインをフラッシュし，プログラムカウンタの値を設定し直す．

### Decode ステージ
Decode ステージでは命令のデコード，レジスタ読み出し，即値の展開を行う．また，データハザードを回避するために，レジスタの書き込み予約を行う．

- Decode

   各演算器に便利なように opecode を変形し，演算種別，signed，packed 等を 1 bit で示した decoded opecode にする．

- レジスタ読みだし

   必要となるオペランドを読み出す．命令中の rd, rs によって示されたレジスタを読み込む．もし，必要なレジスタが書き込み予約されていれば，書き込みが終了するまでストールする．
   
   命令によって必要なレジスタが違っているので，必要最小限のレジスタのみチェックを行うようにしないと，不必要なストールを発生させてしまう．

- 先行命令の終了チェック

   先行命令が次のサイクルまでに終了しない場合は(後続段からストール信号が有効にされている)ストールする．

- レジスタ書き込み予約と命令発行

   ストールを発生する必要がないときはレジスタの書き込みを予約し，デコードされた命令をExecute ステージに送る．

### Execute ステージ
Execute ステージはDecode ステージから送られてきた命令を実行する．既にオペランドは確定しているので，演算種別と条件コードのみ考慮すればよい．
遊星プロセッサでは条件コードによる命令の実行制御を行うため，殆どの命令で条件コードをチェックする必要がある．条件コードが有効な命令の場合はフラグレジスタをチェックし，演算結果を Write Back ステージへ送るか送らないかを決定する．Write Back ステージへ演算結果を送らない場合でも，レジスタの書き込み予約は解除しなくてはならない．したがって，条件コードが一致しなかった場合でもWrite Back ステージへレジスタの書き込み予約解除信号を送る．

- 整数，固定小数点演算器

  加算器および乗算器から成る．各々は 16 bit 毎と 8 bit 毎の packed 演算に対応している．

- シフタ

  32 bit を1サイクルで任意 bit 分シフトすることができる．算術シフト演算が可能．ローテイト命令に対応．16 bit 毎と 8 bit 毎の packed 演算に対応している．

- 論理演算

  AND, OR, NOT, XOR といった論理演算を行う．leading zero (最上位ビットから続く 0 の数をカウントする演算)もこのモジュールが行う．レジスタに即値をセットする命令もここで行う．

- Load Store

  メモリに対する load store を行う．金星プロセッサでは，簡単のため単純な D-FF アレイをデータメモリとして仮定する．従ってレイテンシを考えずに設計する．また，設計を容易にし将来の拡張にも有用であるため，アドレス計算用に独立した加算器を持つ．

- Branch

  分岐命令を実行する．飛び先アドレスを計算するとともに，フラグをチェックする．分岐が成立する場合はプログラムカウンタを飛び先アドレスに変更する信号を生成し，Fetch および Decode ステージをフラッシュする信号を生成する．

### Write Back ステージ
Execute ステージから送られてきた結果をレジスタに書き込み，書き込み予約を解除する．遊星プロセッサではフラグによって命令の実行を制御するため，実行ステージに命令が送られても演算結果をレジスタへ書き込まない場合がある．しかし，この場合もレジスタ書き込み予約を解除しなくてはならない．